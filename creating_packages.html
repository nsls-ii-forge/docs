

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Creating Packages &mdash; docs  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script>
        <script type="text/javascript" src="_static/copybutton.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/copybutton.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="NSLS-II-FORGE Documentation" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> docs
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Creating Packages</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#directory-structure">Directory structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#set-up-the-development-environment">Set up the development environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#install-conda-smithy">Install “conda-smithy”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#install-keybase">Install Keybase</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configure-conda-smithy">Configure “conda-smithy”</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-a-root-directory-for-packages">Create a root directory for packages</a></li>
<li class="toctree-l3"><a class="reference internal" href="#clone-the-event-model-feedstock-repository-from-the-nsls-ii-forge-github-org">Clone the “event-model-feedstock” repository from the nsls-ii-forge GitHub org</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#generate-and-edit-the-meta-yaml-recipe-configuration-file">Generate and edit the <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> recipe configuration file</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#generate-a-recipe-from-a-pypi-package">Generate a recipe from a PyPI package</a></li>
<li class="toctree-l3"><a class="reference internal" href="#manually-create-a-recipe-or-use-the-existing-recipe">Manually create a recipe or use the existing recipe</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#prepare-recipe-files">Prepare recipe files</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#collect-additional-files">Collect additional files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#generate-an-empty-feedstock-repository">Generate an empty feedstock repository</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#initialize-a-feedstock">Initialize a feedstock</a></li>
<li class="toctree-l3"><a class="reference internal" href="#define-azure-variables">Define Azure variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#create-a-github-repository-and-push-files">Create a GitHub repository and push files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#enable-ci-on-azure-pipelines">Enable CI on Azure Pipelines</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#rerender-and-push-the-feedstock-repository">Rerender and push the feedstock repository</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#rerender-the-feedstock">Rerender the feedstock</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#create-a-pull-request-on-github">Create a pull request on GitHub</a></li>
<li class="toctree-l2"><a class="reference internal" href="#known-or-possible-issues">Known or possible issues</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#tests-fail-for-linux-due-to-a-missing-opengl">Tests fail for Linux due to a missing OpenGL</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">docs</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Creating Packages</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/creating_packages.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="creating-packages">
<h1>Creating Packages<a class="headerlink" href="#creating-packages" title="Permalink to this headline">¶</a></h1>
<p>Feedstocks for <a class="reference external" href="https://dev.azure.com/nsls2forge/nsls2forge/_build">Azure Pipelines</a> may be generated based
on the following sources (listed in the order of preference):</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/conda-forge">conda-forge feedstocks</a>;</p></li>
<li><p><a class="reference external" href="https://pypi.org/">PyPI packages</a>;</p></li>
<li><p>package recipes from
<a class="reference external" href="https://github.com/NSLS-II/lightsource2-recipes/tree/master/recipes-tag">lightsource2-recipes</a>.</p></li>
</ul>
<p>For a new package, the recipes (in the form of <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> file) can be
created manually from a generic template for <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> file and specific
package requirements.</p>
<div class="section" id="directory-structure">
<h2>Directory structure<a class="headerlink" href="#directory-structure" title="Permalink to this headline">¶</a></h2>
<p>The following directory structure for the packaging project is recommended:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">~/src/nsls-ii-forge/</span></code> – root directory in which packages will be
placed. This is only a recommended name. In practice, root directory may
have arbitrary name and placed in any convenient spot.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">~/src/nsls-ii-forge/event-model-feedstock</span></code> – the directory with cloned
<strong>event-model-feedstock</strong> repository.</p></li>
</ul>
</div></blockquote>
<p>For each package we will create a temporary directory that may be deleted after
a feedstock is initialized and the feedstock directory that will contain the
feedstock repository:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">~/src/nsls-ii-forge/&lt;package_name&gt;</span></code> – a temporary directory with the
package’s recipe. The directory is created by <strong>conda skeleton</strong> or
manually. The directory name has to match the package name, since this is
the directory where <strong>conda-smithy</strong> will be looking for the recipe file
<code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> (for example, recipes for <strong>sixtools</strong> package must be placed
in <code class="docutils literal notranslate"><span class="pre">~/src/nsls-ii-forge/sixtools</span></code> directory).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">~/src/nsls-ii-forge/&lt;package-name&gt;-feedstock</span></code> – a directory that
contains the feedstock repository, which is uploaded to the corresponding
repository in the <strong>nsls-ii-forge</strong> GitHub organization.  The directory is
created by <strong>conda-smithy</strong> as a part of feedstock initialization.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="set-up-the-development-environment">
<h2>Set up the development environment<a class="headerlink" href="#set-up-the-development-environment" title="Permalink to this headline">¶</a></h2>
<div class="section" id="install-conda-smithy">
<h3>Install “conda-smithy”<a class="headerlink" href="#install-conda-smithy" title="Permalink to this headline">¶</a></h3>
<p>Create a new conda environment (let’s name it <code class="docutils literal notranslate"><span class="pre">smithy</span></code>):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda create -n smithy -c conda-forge conda-smithy <span class="s2">&quot;python&gt;=3&quot;</span>
$ conda activate smithy
</pre></div>
</div>
</div>
<div class="section" id="install-keybase">
<h3>Install Keybase<a class="headerlink" href="#install-keybase" title="Permalink to this headline">¶</a></h3>
<p>Use the <a class="reference external" href="https://keybase.io/download">installation instructions</a> to download
and install <strong>Keybase</strong>. Start <strong>Keybase</strong> and log into the system (DAMA
group). Check if tokens are downloaded to the directory on your local hard
drive (<code class="docutils literal notranslate"><span class="pre">/keybase/team/dama/</span></code> on Linux and MacOS systems).</p>
</div>
<div class="section" id="configure-conda-smithy">
<h3>Configure “conda-smithy”<a class="headerlink" href="#configure-conda-smithy" title="Permalink to this headline">¶</a></h3>
<p>Create the directory <code class="docutils literal notranslate"><span class="pre">~/.conda-smithy</span></code> (in your home directory).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mkdir ~/.conda-smithy
</pre></div>
</div>
<p>Copy tokens named <code class="docutils literal notranslate"><span class="pre">anaconda.token</span></code>, <code class="docutils literal notranslate"><span class="pre">azure.token</span></code> and <code class="docutils literal notranslate"><span class="pre">github.token</span></code> to
<code class="docutils literal notranslate"><span class="pre">~/.conda-smithy</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cp /keybase/team/dama/anaconda.token ~/.conda-smithy/
$ cp /keybase/team/dama/azure.token ~/.conda-smithy/
$ cp /keybase/team/dama/github.token ~/.conda-smithy/
</pre></div>
</div>
</div>
<div class="section" id="create-a-root-directory-for-packages">
<h3>Create a root directory for packages<a class="headerlink" href="#create-a-root-directory-for-packages" title="Permalink to this headline">¶</a></h3>
<p>Naming and location of the root working directory is arbitrary. We will place
packages in the directory <code class="docutils literal notranslate"><span class="pre">~/src/nsls-ii-forge/</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mkdir -p ~/src/nsls-ii-forge
</pre></div>
</div>
</div>
<div class="section" id="clone-the-event-model-feedstock-repository-from-the-nsls-ii-forge-github-org">
<h3>Clone the “event-model-feedstock” repository from the nsls-ii-forge GitHub org<a class="headerlink" href="#clone-the-event-model-feedstock-repository-from-the-nsls-ii-forge-github-org" title="Permalink to this headline">¶</a></h3>
<p>The <strong>event-model-feedstock</strong> needs to be cloned only once. In the process of
creating packages we will be using the <code class="docutils literal notranslate"><span class="pre">conda-forge.yml</span></code> file located in the
<code class="docutils literal notranslate"><span class="pre">~/src/nsls-ii-forge/event-model-feedstock/</span></code> directory and the
<code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code> file located in the
<code class="docutils literal notranslate"><span class="pre">~/src/nsls-ii-forge/event-model-feedstock/recipe/</span></code> directory.  If you
already have it cloned, pull the latest version of the
<strong>event-model-feedstock</strong> since the repository may be updated.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/src/nsls-ii-forge
$ git clone https://github.com/nsls-ii-forge/event-model-feedstock.git
</pre></div>
</div>
</div>
</div>
<div class="section" id="generate-and-edit-the-meta-yaml-recipe-configuration-file">
<h2>Generate and edit the <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> recipe configuration file<a class="headerlink" href="#generate-and-edit-the-meta-yaml-recipe-configuration-file" title="Permalink to this headline">¶</a></h2>
<p>There are several ways to create the package recipe:</p>
<ul class="simple">
<li><p>use the existing <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> recipe file (e.g., from a <strong>conda-forge</strong>
feedstock repository);</p></li>
<li><p>generate a recipe from the existing PyPI package using <strong>conda skeleton</strong>;</p></li>
<li><p>manually create a <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> recipe file.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is important that each of the following commands is run from the correct
directory. Since it is easy to lose track of directory changes, all the
paths will be specified relative to the <code class="docutils literal notranslate"><span class="pre">$HOME</span></code> directory.</p>
</div>
<div class="section" id="generate-a-recipe-from-a-pypi-package">
<h3>Generate a recipe from a PyPI package<a class="headerlink" href="#generate-a-recipe-from-a-pypi-package" title="Permalink to this headline">¶</a></h3>
<p>If the package <code class="docutils literal notranslate"><span class="pre">&lt;package-name&gt;</span></code> is available from PyPI, generate a recipe
from the existing package:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/src/nsls-ii-forge
$ conda skeleton pypi &lt;package-name&gt; --noarch
</pre></div>
</div>
<p>Check if <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> was successfully created in the
<code class="docutils literal notranslate"><span class="pre">~/src/nsls-ii-forge/&lt;package-name&gt;</span></code> directory.</p>
<p>Edit the <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> file:</p>
<ul>
<li><p>Remove all entries from the <code class="docutils literal notranslate"><span class="pre">requirements:</span> <span class="pre">host:</span></code> section except
<code class="docutils literal notranslate"><span class="pre">python</span></code> and <code class="docutils literal notranslate"><span class="pre">pip</span></code>.</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">requires:</span></code> and <code class="docutils literal notranslate"><span class="pre">commands:</span></code> to the <code class="docutils literal notranslate"><span class="pre">test:</span></code> section
(if applicable).</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">requires</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pytest</span>
<span class="nt">commands</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">pytest --pyargs sixtools.tests</span>
</pre></div>
</div>
</li>
<li><p>Remove the following lines from the <code class="docutils literal notranslate"><span class="pre">about:</span></code> section:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">doc_url</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
<span class="nt">dev_url</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
</pre></div>
</div>
</li>
<li><p>Additional steps:</p>
<ul class="simple">
<li><p>Add <code class="docutils literal notranslate"><span class="pre">LICENSE</span></code> to the <code class="docutils literal notranslate"><span class="pre">license_file</span></code> field of the <code class="docutils literal notranslate"><span class="pre">about:</span></code> section.</p></li>
<li><p>Update the home URL in <code class="docutils literal notranslate"><span class="pre">about:</span></code> section to point to the package’s GitHub
repository or a dedicated web site if it exists.</p></li>
<li><p>Remove the <code class="docutils literal notranslate"><span class="pre">extra:</span></code> block (including the list of maintainers).</p></li>
</ul>
</li>
</ul>
<p>An example of the edited <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> for the <strong>sixtools</strong> package may be
found at the <a class="reference external" href="https://github.com/nsls-ii-forge/sixtools-feedstock/blob/master/recipe/meta.yaml">sixtools-feedstock repository</a>.</p>
</div>
<div class="section" id="manually-create-a-recipe-or-use-the-existing-recipe">
<h3>Manually create a recipe or use the existing recipe<a class="headerlink" href="#manually-create-a-recipe-or-use-the-existing-recipe" title="Permalink to this headline">¶</a></h3>
<p>This is an alternative method of preparing the recipe if the package is not
available at PyPI. Create a temporary directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/src/nsls-ii-forge
$ mkdir &lt;package-name&gt;
$ <span class="nb">cd</span> &lt;package-name&gt;
</pre></div>
</div>
<p>The recipe may be created based on the <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> file from the respective
<strong>conda-forge</strong> feedstock (and sometimes from the original package repository).
If such a file is not available or unusable, find an appropriate sample
<code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> (from a similar package that was successfully built) and modify
it.  Copy <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> file to the temporary directory you just created:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ cp &lt;path-to-meta-yaml-file&gt;/meta.yml .
</pre></div>
</div>
<p>or download <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> from a known URL:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ wget https://&lt;url-of-meta-yaml-file&gt;/meta.yaml
</pre></div>
</div>
<p>Open and edit the <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> file.</p>
</div>
</div>
<div class="section" id="prepare-recipe-files">
<h2>Prepare recipe files<a class="headerlink" href="#prepare-recipe-files" title="Permalink to this headline">¶</a></h2>
<div class="section" id="collect-additional-files">
<h3>Collect additional files<a class="headerlink" href="#collect-additional-files" title="Permalink to this headline">¶</a></h3>
<p>Copy the <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code> file into your recipe directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/src/nsls-ii-forge
$ cp event-model-feedstock/recipe/conda_build_config.yaml &lt;package-name&gt;/
</pre></div>
</div>
<p>Open and inspect <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/src/nsls-ii-forge/&lt;package-name&gt;
$ emacs conda_build_config.yaml <span class="p">&amp;</span>
</pre></div>
</div>
<p>This is the contents of a typical <code class="docutils literal notranslate"><span class="pre">conda_build_config.yaml</span></code> file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">channel_sources</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">nsls2forge,defaults</span>
<span class="nt">channel_targets</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">nsls2forge main</span>
<span class="nt">python</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;3.6&#39;</span>
</pre></div>
</div>
<p>If you are building a <code class="docutils literal notranslate"><span class="pre">noarch</span></code> package, then close the file without change.
For an architecture-dependent package, a set of Python versions are specified
in the <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> file and the following lines should be removed:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">python</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="s">&#39;3.6&#39;</span>
</pre></div>
</div>
<p>Copy the license file from the original package repository into the recipe
directory.  The license file is typically named <code class="docutils literal notranslate"><span class="pre">LICENSE</span></code> (without an
extension), but in some projects the name may differ (e.g. <code class="docutils literal notranslate"><span class="pre">COPYRIGHT</span></code>). The
spelling of the license file name should match the name specified in the
<code class="docutils literal notranslate"><span class="pre">license_file</span></code> field of the <code class="docutils literal notranslate"><span class="pre">about:</span></code> section of the <code class="docutils literal notranslate"><span class="pre">meta.yaml</span></code> file (see
the instructions above). For example, the BSD license used for the Bluesky
project may be copied to recipes as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/src/nsls-ii-forge/&lt;package-name&gt;
$ wget https://raw.githubusercontent.com/bluesky/bluesky/master/LICENSE
</pre></div>
</div>
<p>Now the content of the recipe directory <code class="docutils literal notranslate"><span class="pre">~/src/nsns-ii-forge/&lt;package-name&gt;</span></code>
should look similar to this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>drwxr-xr-x <span class="m">2</span> user user <span class="m">4096</span> Sep <span class="m">13</span> <span class="m">12</span>:45 .
drwxr-xr-x <span class="m">3</span> user user <span class="m">4096</span> Sep <span class="m">13</span> <span class="m">12</span>:10 ..
-rw-r--r-- <span class="m">1</span> user user   <span class="m">96</span> Sep <span class="m">13</span> <span class="m">12</span>:44 conda_build_config.yaml
-rw-r--r-- <span class="m">1</span> user user <span class="m">1584</span> Sep <span class="m">13</span> <span class="m">12</span>:45 LICENSE
-rw-r--r-- <span class="m">1</span> user user <span class="m">1064</span> Sep <span class="m">13</span> <span class="m">12</span>:10 meta.yaml
</pre></div>
</div>
</div>
</div>
<div class="section" id="generate-an-empty-feedstock-repository">
<h2>Generate an empty feedstock repository<a class="headerlink" href="#generate-an-empty-feedstock-repository" title="Permalink to this headline">¶</a></h2>
<div class="section" id="initialize-a-feedstock">
<h3>Initialize a feedstock<a class="headerlink" href="#initialize-a-feedstock" title="Permalink to this headline">¶</a></h3>
<p>Initialize a feedstock using <strong>conda-smithy</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/src/nsls-ii-forge
$ conda-smithy init &lt;package-name&gt;
</pre></div>
</div>
<p>A new directory <code class="docutils literal notranslate"><span class="pre">~/src/nsls-ii-forge/&lt;package-name&gt;-feedstock</span></code> is created.</p>
<p>Replace <code class="docutils literal notranslate"><span class="pre">conda-forge.yml</span></code> in the feedstock directory with <code class="docutils literal notranslate"><span class="pre">conda-forge.yml</span></code>
from the nsls-ii-forge’s <code class="docutils literal notranslate"><span class="pre">event-model-feedstock</span></code> package you cloned before:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/src/nsls-ii-forge
$ cp event-model-feedstock/conda-forge.yml &lt;package-name&gt;-feedstock/
</pre></div>
</div>
</div>
<div class="section" id="define-azure-variables">
<h3>Define Azure variables<a class="headerlink" href="#define-azure-variables" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">export</span> <span class="nv">AZURE_ORG_OR_USER</span><span class="o">=</span>nsls2forge
$ <span class="nb">export</span> <span class="nv">AZURE_PROJECT_NAME</span><span class="o">=</span>nsls2forge
</pre></div>
</div>
<p>For convenience, the above lines may be added to the <code class="docutils literal notranslate"><span class="pre">~/.bashrc</span></code> file so that
the environment variables are always available.</p>
</div>
<div class="section" id="create-a-github-repository-and-push-files">
<h3>Create a GitHub repository and push files<a class="headerlink" href="#create-a-github-repository-and-push-files" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ <span class="nb">cd</span> ~/src/nsls-ii-forge/&lt;package-name&gt;-feedstock
$ git add .
$ git commit -m <span class="s2">&quot;Use nsls2forge&#39;s conda-forge.yml&quot;</span>
$ conda smithy register-github --organization nsls-ii-forge ./
$ git push -u upstream master
</pre></div>
</div>
</div>
<div class="section" id="enable-ci-on-azure-pipelines">
<h3>Enable CI on Azure Pipelines<a class="headerlink" href="#enable-ci-on-azure-pipelines" title="Permalink to this headline">¶</a></h3>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda smithy register-ci --organization nsls-ii-forge --without-circle <span class="se">\</span>
--without-appveyor --without-travis --without-drone --feedstock_directory ./
</pre></div>
</div>
<p>Verify that CI was enabled on Azure Pipelines. Check for the following line in
the output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>* nsls-ii-forge/&lt;package-name&gt;-feedstock has been enabled on azure pipelines
</pre></div>
</div>
</div>
</div>
<div class="section" id="rerender-and-push-the-feedstock-repository">
<h2>Rerender and push the feedstock repository<a class="headerlink" href="#rerender-and-push-the-feedstock-repository" title="Permalink to this headline">¶</a></h2>
<div class="section" id="rerender-the-feedstock">
<h3>Rerender the feedstock<a class="headerlink" href="#rerender-the-feedstock" title="Permalink to this headline">¶</a></h3>
<p>Create a new branch <code class="docutils literal notranslate"><span class="pre">rerender</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ git checkout -b rerender
</pre></div>
</div>
<p>Rerender the feedstock:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda smithy rerender --feedstock_directory ./
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>From time to time <code class="docutils literal notranslate"><span class="pre">conda-smithy</span></code> may inform a user that its version is
out-of-date, e.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="ne">RuntimeError</span><span class="p">:</span> <span class="n">conda</span><span class="o">-</span><span class="n">smithy</span> <span class="n">version</span> <span class="ow">in</span> <span class="n">root</span> <span class="n">env</span> <span class="p">(</span><span class="mf">3.4</span><span class="o">.</span><span class="mi">6</span><span class="p">)</span> <span class="ow">is</span> <span class="n">out</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">date</span> <span class="p">(</span><span class="mf">3.4</span><span class="o">.</span><span class="mi">7</span><span class="p">)</span><span class="o">.</span> <span class="n">Exiting</span><span class="o">.</span>
</pre></div>
</div>
<p>Update <code class="docutils literal notranslate"><span class="pre">conda-smithy</span></code> to use the latest features:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ conda install conda-smithy -c conda-forge
</pre></div>
</div>
</div>
<p>Commit the changes (the following command should be copied from the terminal
output produced by the previous command):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ git commit -m <span class="s2">&quot;MNT: Re-rendered with conda-build 3.18.9, conda-smithy 3.4.6, and conda-forge-pinning 2019.09.08&quot;</span>
</pre></div>
</div>
<p>Push changes to <cite>upstream</cite>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ git push -u upstream rerender
</pre></div>
</div>
</div>
</div>
<div class="section" id="create-a-pull-request-on-github">
<h2>Create a pull request on GitHub<a class="headerlink" href="#create-a-pull-request-on-github" title="Permalink to this headline">¶</a></h2>
<p>Open the GitHub page
<code class="docutils literal notranslate"><span class="pre">https://github.com/nsls-ii-forge/&lt;package-name&gt;-feedstock</span></code> and create a pull
request. In the pull request comments include a brief note and <strong>the link to
the original repository</strong> of the package (PyPI, conda-forge or GitHub).</p>
<p>Closely examine the build results to ensure that the packages were built for
all target platforms and Python versions and all tests passed successfully.
Correct issues if necessary.  Each time a change is made to configuration
files, the feedstock must be rerendered and changes must be committed and
pushed. Merge the pull request once all issues are fixed and the build statuses
are <span class="raw-html"><font color="green">green</font></span>.</p>
<p>Once the PR build is finished, the new package or its new version will be
uploaded to the <a class="reference external" href="https://anaconda.org">Anaconda Cloud</a>.</p>
</div>
<div class="section" id="known-or-possible-issues">
<h2>Known or possible issues<a class="headerlink" href="#known-or-possible-issues" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tests-fail-for-linux-due-to-a-missing-opengl">
<h3>Tests fail for Linux due to a missing OpenGL<a class="headerlink" href="#tests-fail-for-linux-due-to-a-missing-opengl" title="Permalink to this headline">¶</a></h3>
<p>The solution is to place the file <a class="reference external" href="https://raw.githubusercontent.com/nsls-ii-forge/collection-feedstock/master/recipe/yum_requirements.txt">yum_requirements.txt</a>
into the recipes directory
<code class="docutils literal notranslate"><span class="pre">~/src/nsls-ii-forge/&lt;package-name&gt;-feedstock/recipes</span></code>, then rerender, commit
and push changes.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="index.html" class="btn btn-neutral float-left" title="NSLS-II-FORGE Documentation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Documentation for NSLS-II Forge

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>